import { Component, OnInit } from '@angular/core';
import {AuthService} from '../../utility/auth-service';
import {Router} from '@angular/router';
import {MenuProvider} from './menu.provider';
import {MatDialog} from '@angular/material';
import {LoginComponent} from '../login/login.component';

@Component({
    selector: 'app-menu',
    templateUrl: './menu.component.html',
    styleUrls: ['./menu.component.scss']
})
export class MenuComponent implements OnInit {
    loader: boolean = false;
    userLocation: {lat: any; lng: any;};
    component: any;
    cartLength: string;
    loginUserEmail: string;
    loginUserImage: string;
    loginUserName: string;
    loginDone: string;
    lat: number;
    lng: number;
    zoom: number = 17;
    carrerModel: {mobileNo?: number, firstName?: string, middleName?: string, lastName?: string, emailId?: string, reason?: string, message?: string, uid?: string} = {};
    constructor(public auth: AuthService, public router: Router, public provider: MenuProvider, public dialog: MatDialog) {}

    ngOnInit() {
        this.cartLength = localStorage.getItem("cartLength");
        this.getLoginUserData();
        this.getUserPosition();
    }
    
    getLoginUserData()
    {
        this.loginDone = localStorage.getItem("isLoggedin");
        if (this.loginDone != null)
        {
            this.loginUserName = this.auth.getSession().displayName;
            this.loginUserImage = this.auth.getSession().photoURL;
            this.loginUserEmail = this.auth.getSession().email;
        }
    }
    
    logOut()
    {
        localStorage.removeItem('isLoggedin');
        localStorage.clear();
        localStorage.clear();
        this.router.navigate(['/home']);
    }
    
    getUserPosition()
    {
        this.provider.getPosition().then(async location =>
        {
            var lat = localStorage.getItem("lat")
            var lng = localStorage.getItem("lng")
            if(lat == null && lng == null)
            {
                this.userLocation = {
                    lat: location.lat,
                    lng: location.lng
                }
                this.lat = this.userLocation.lat;
                this.lng = this.userLocation.lng;
            }
            else
            {
                this.userLocation = {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng)
                }
                this.lat = this.userLocation.lat;
                this.lng = this.userLocation.lng;
            }
        })
    }
    
    openLoginDialog()
    {
        this.component = LoginComponent;
        const dialogRef = this.dialog.open(this.component,
        {
            width : '40%',
            height : '80%',
        });
        dialogRef.afterClosed().subscribe(result =>
        {
            this.router.navigate(['/home']);
        })
    }
    
    saveCarrerFormInfo(Obj)
    {
        this.loader = true;
        this.provider.saveCarrerFormInfo(Obj).then(data =>
        {
            this.loader = false;
            this.router.navigate(['/home']);
        }).catch(error =>
        {
            this.loader = false;
            this.router.navigate(['/error']);
        })
    }
}
